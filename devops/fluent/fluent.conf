<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

; <source>
;   @type prometheus_pull
;   host prometheus
;   port 9090
;   tag metric
;   metrics_path /api/v1/query
;   interval 5s
;   scrape_interval 15s
; </source>

; <filter prometheus.**>
;   @type record_transformer
;   <record>
;     job ${job}
;     instance ${instance}
;   </record>
; </filter>

<filter docker.**>
  @type concat
  key log
  multiline_start_regexp /^\[START\]/
  multiline_end_regexp /^\[END\]/
  separator "\n"
  flush_interval 5s
  timeout_label @CONCAT_ERROR
</filter>

# Container Logs to Elasticsearch
<match docker.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme http
  user ${FLUENT_ELASTICSEARCH_USER}
  password ${FLUENT_ELASTICSEARCH_PASSWORD}
# Force fluent-plugin-elasticsearch to treat it as ES 8:
  major_version 8
  logstash_format false
  include_tag_key true
  tag_key @tag
  index_name ${tag}
  verify_es_version_at_startup true
  suppress_type_name true
  time_key @timestamp
  time_key_format %Y-%m-%dT%H:%M:%S.%NZ
  include_timestamp true
  reconnect_on_error true
  reload_on_failure true
  reload_connections false
  chunk_limit_size 64m
  <buffer tag,time>
    @type file
    path /fluentd/log/buffer
    timekey 60
    timekey_wait 10s
    timekey_use_utc true
    flush_mode interval
    flush_interval 5s
    retry_forever true
    retry_max_times 15
    chunk_limit_size 64m
  </buffer>
</match>

; <match prometheus.**>
;   @type elasticsearch
;   host elasticsearch
;   port 9200
;   scheme http
;   logstash_format false
;   index_name cadvisor-metrics
;   flush_interval 5s
;   include_tag_key true
;   tag_key @tag
;   time_key @timestamp
;   time_key_format %Y-%m-%dT%H:%M:%S.%NZ
;   <buffer>
;     @type file
;     path /fluentd/log/cadvisor-metrics
;     timekey 60
;     timekey_wait 10s
;     timekey_use_utc true
;     flush_interval 10s
;     chunk_limit_size 64m
;     retry_forever true
;   </buffer>
; </match>

<label @CONCAT_ERROR>
  <match **>
    @type stdout
    @log_level error
  </match>
</label>
