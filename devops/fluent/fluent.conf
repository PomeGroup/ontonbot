<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

# System Metrics Collection
<source>
  @type prometheus
  bind 0.0.0.0
  port 24231
</source>

<source>
  @type prometheus_monitor
  labels { "host": "${hostname}" }
</source>

<filter docker.**>
  @type concat
  key log
  multiline_start_regexp /^\[START\]/
  multiline_end_regexp /^\[END\]/
  separator "\n"
  flush_interval 5s
  timeout_label @CONCAT_ERROR
</filter>

# Container Logs to Elasticsearch
<match docker.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme http
  user ${FLUENT_ELASTICSEARCH_USER}
  password ${FLUENT_ELASTICSEARCH_PASSWORD}
  logstash_format false
  include_tag_key true
  tag_key @tag
  index_name ${tag}
  verify_es_version_at_startup true
  suppress_type_name true
  time_key @timestamp
  time_key_format %Y-%m-%dT%H:%M:%S.%NZ
  include_timestamp true
  reconnect_on_error true
  reload_on_failure true
  reload_connections false
  chunk_limit_size 64m
  <buffer tag,time>
    @type file
    path /fluentd/log/buffer
    timekey 60
    timekey_wait 10s
    timekey_use_utc true
    flush_mode interval
    flush_interval 5s
    retry_forever true
    retry_max_times 15
    chunk_limit_size 64m
  </buffer>
</match>

# System Metrics to Elasticsearch
<match prometheus.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  scheme http
  user ${FLUENT_ELASTICSEARCH_USER}
  password ${FLUENT_ELASTICSEARCH_PASSWORD}
  logstash_format true
  include_tag_key true
  tag_key @tag
  index_name system-metrics
  flush_interval 5s

  <buffer tag,time>
    @type file
    path /fluentd/log/system_metrics_buffer
    timekey 86400
    timekey_wait 10m
    timekey_use_utc true
    flush_mode interval
    flush_interval 60s
    retry_forever true
    retry_max_times 10
  </buffer>
</match>

<label @CONCAT_ERROR>
  <match **>
    @type stdout
    @log_level error
  </match>
</label>
