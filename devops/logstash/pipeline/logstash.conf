input {
  udp {
    port => 5044
    codec => multiline {
      pattern => "^(\\s+)"
      what => "previous"
      negate => false
    }
    type => "syslog-docker"
  }
}

filter {
  # Extract syslog header and Docker tag
  grok {
    match => {
      "message" => "^<%{NUMBER:syslog_pri}>%{SYSLOGTIMESTAMP:syslog_timestamp} %{HOSTNAME:syslog_hostname} %{DATA:docker_tag}\\[%{POSINT:pid}\\]: %{GREEDYDATA:log_message}"
    }
  }

  # Replace `message` with the extracted `log_message`
  mutate {
    replace => { "message" => "%{log_message}" }
    remove_field => [ "log_message" ]
  }

  # Optional: Add structured fields or additional processing if needed
  date {
    match => ["syslog_timestamp", "MMM dd HH:mm:ss"]
    target => "@timestamp"
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{[docker_tag]}-%{+YYYY.MM.dd}"
    ecs_compatibility => "v8"
  }

  stdout {
    codec => rubydebug {
      metadata => true
    }
  }
}
