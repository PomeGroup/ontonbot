# minimum-image
FROM node:22-alpine3.19 AS minimum-image
RUN apk update
RUN npm i -g pnpm
# ARGS
ARG ENV
ARG DATABASE_URL_NFT_MANAGER
ARG TON_CENTER_TOKEN
ARG TONAPI_API_KEY
ARG DATABASE_URL
ARG POSTGRES_USER
ARG POSTGRES_PASSWORD
ARG BOT_TOKEN
ARG NEXT_PUBLIC_APP_BASE_URL
ARG NEXT_PUBLIC_BOT_USERNAME
ARG CACHE_ENABLED
ARG TG_NOTIFICATION_CHANELL
ARG ONTON_API_SECRET
ARG TON_SOCIETY_API_KEY
ARG TON_SOCIETY_BASE_URL
ARG REDIS_HOST
ARG REDIS_PORT
ARG REDIS_PASSWORD
ARG REDIS_DATABASES
ARG MINI_APP_PORT
ARG IP_NFT_MANAGER
ARG NFT_MANAGER_PORT
ARG CLIENT_API_JWT_SECRET
ARG CLIENT_API_FIXED_KEY
ARG CLIENT_API_FIXED_USER
ARG CLIENT_API_FIXED_ORGANIZER
ARG TG_LOG_BOT_TOKEN
ARG TG_LOGS_GROUP_ID
ARG TG_TICKETS_TOPIC
ARG TG_EVENTS_TOPIC
ARG TG_SYSTEM_TOPIC
# Export arguments as environment variables
ENV ENV=${ENV}
ENV DATABASE_URL_NFT_MANAGER=${DATABASE_URL_NFT_MANAGER}
ENV TON_CENTER_TOKEN=${TON_CENTER_TOKEN}
ENV TONAPI_API_KEY=${TONAPI_API_KEY}
ENV DATABASE_URL=${DATABASE_URL}
ENV POSTGRES_USER=${POSTGRES_USER}
ENV POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
ENV BOT_TOKEN=${BOT_TOKEN}
ENV NEXT_PUBLIC_APP_BASE_URL=${NEXT_PUBLIC_APP_BASE_URL}
ENV NEXT_PUBLIC_BOT_USERNAME=${NEXT_PUBLIC_BOT_USERNAME}
ENV CACHE_ENABLED=${CACHE_ENABLED}
ENV TG_NOTIFICATION_CHANELL=${TG_NOTIFICATION_CHANELL}
ENV ONTON_API_SECRET=${ONTON_API_SECRET}
ENV TON_SOCIETY_API_KEY=${TON_SOCIETY_API_KEY}
ENV TON_SOCIETY_BASE_URL=${TON_SOCIETY_BASE_URL}
ENV REDIS_HOST=${IP_REDIS}
ENV REDIS_PORT=${REDIS_PORT}
ENV REDIS_PASSWORD=${REDIS_PASSWORD}
ENV REDIS_DATABASES=${REDIS_DATABASES}
ENV MINI_APP_PORT=${MINI_APP_PORT}
ENV IP_NFT_MANAGER=${IP_NFT_MANAGER}
ENV NFT_MANAGER_PORT=${NFT_MANAGER_PORT}
ENV CLIENT_API_JWT_SECRET=${CLIENT_API_JWT_SECRET}
ENV CLIENT_API_FIXED_KEY=${CLIENT_API_FIXED_KEY}
ENV CLIENT_API_FIXED_USER=${CLIENT_API_FIXED_USER}
ENV CLIENT_API_FIXED_ORGANIZER=${CLIENT_API_FIXED_ORGANIZER}
ENV TG_LOG_BOT_TOKEN=${TG_LOG_BOT_TOKEN}
ENV TG_LOGS_GROUP_ID=${TG_LOGS_GROUP_ID}
ENV TG_TICKETS_TOPIC=${TG_TICKETS_TOPIC}
ENV TG_EVENTS_TOPIC=${TG_EVENTS_TOPIC}
ENV TG_SYSTEM_TOPIC=${TG_SYSTEM_TOPIC}
# Set the working directory
# Base stage
FROM minimum-image AS base
# Install necessary packages
RUN apk add \
  bash \
  curl \
  ca-certificates


# Stage : Dependencies
FROM base AS dependencies
# Copy package files for dependency installation
COPY ./package.json  /app/
# Set working directory
WORKDIR /app
# Install production dependencies only
RUN  pnpm install --prod

# Stage : With Files
FROM dependencies AS with-files
# Copy the entire project to be used in the build stages
COPY . /app

# Stage : Build Stage
FROM with-files AS build-stage
RUN echo "Build stage files " && ls -la /app && ls -la
RUN  pnpm install
# Build the Next.js application
RUN pnpm run build
# Clean up unnecessary files to reduce image size

# Stage : Production Stage
FROM build-stage AS production
# Expose the necessary port for mini-app (Next.js)

EXPOSE $MINI_APP_PORT
# Default command for the Next.js app
CMD  node ./node_modules/next/dist/bin/next start  --port $MINI_APP_PORT

# Stage : Development Stage
FROM minimum-image AS development
# Copy the entire project to be used in the build stages
COPY . /app
EXPOSE $MINI_APP_PORT
# Set the working directory
WORKDIR /app
# Run the app in development mode
CMD export NODE_ENV=development && pnpm install  && node ./node_modules/next/dist/bin/next dev  --port $MINI_APP_PORT

